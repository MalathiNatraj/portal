@{
    ViewBag.Title = "AccessView";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=320,user-scalable=false" />
    <link rel="stylesheet" type="text/css" href="../../Content/style.css">
    <!--[if gte IE 9]>
        <link rel="stylesheet" type="text/css" href="css/gradient-ie6-and-up.css" />
	<![endif]-->
    <title>Diebold</title>
   <script src="@Url.Content("~/Scripts/jquery.blockUI.js")" type="text/javascript"></script>
    <link href="@Url.Content("~/Content/kendo.dataviz.min.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Scripts/jquery.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.dataviz.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.aspnetmvc.min.js")" type="text/javascript"></script>
    <link rel="stylesheet" href="@Url.Content("~/Content/kendo.common.min.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Content/kendo.default.min.css")" />
    <script src="@Url.Content("~/Scripts/jquery.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.web.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery-1.9.1.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/nav/multilevel.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/nav/responder.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/nav/slider.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/app/Common.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.blockUI.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/app/BlockUIForms.js")" type="text/javascript"></script>
    <link href="@Url.Content("~/Content/BlockUIForms.css")" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        $(document).ready(function () {
            $.ajax({
                url: '@Url.Action("GetAccessDevices", "Access")',
                type: 'POST',
                data: { parentType: 'DVR' },
                success: function (data) {                   
                    $.each(data, function (index, itemData) {
                        $('#AccessViewDeviceList').val('Select Device');
                        $('#AccessViewDeviceList').append($('<option/>', {
                            value: itemData.Id,
                            text: itemData.SiteName + ' : '+  itemData.Name
                        })
                        );
                    });
                },
                error: function (errordata) {
                    alert('Failure')
                }
            });

            $('#AccessViewDeviceList').change(function () {
                BlockElement("dvAccessPortlet", 'Connecting...');
                var deviceId = $("#AccessViewDeviceList").val();
                if (deviceId != null && deviceId != undefined && deviceId != '' && deviceId != 'Select Device') {
                    fnGetAccessInformation(deviceId);
                }
                else
                    UnBlockElement("dvAccessPortlet");
            });
        });

        function fnGetAccessInformation(deviceId) {
            $.ajax({
                url: '@Url.Action("GetAccessDetails", "Access")',
                type: 'POST',
                data: { deviceId: deviceId },
                success: function (data) {
                    fnLoadDoorInformationn(data)
                },
                error: function (errordata) {
                    alert('Failure')
                }
            });
        }

        function fnLoadDoorInformationn(Result) {
            if (Result != null && Result != undefined) {
                if (Result.Message != null && Result.Message != undefined && Result.Message != "") {
                    fnAccessMsgInfo(Result.Message);
                }
                else {
                    var cList = $('#dvAccessInfo');
                    $("#dvAccessInfo").empty();
                    $.each(Result, function (index, itemData) {
                        var dvParent = $('<div/>').addClass('box-cont-bg').appendTo(cList);
                        var dvDoorDiv = $('<div/>').addClass('lft-cont').appendTo(dvParent);
                        var ptag = $('<p/>').appendTo(dvDoorDiv);
                        $('<a/>').text('Door: ' + itemData.DoorName).appendTo(ptag);

                        var dvBtnParentDiv = $('<div/>').addClass('right-cont').appendTo(dvParent);
                        var dvBtnChild = $('<div/>').addClass('big-active-btn').appendTo(dvBtnParentDiv);
                        var pBtntag = $('<p/>').appendTo(dvBtnChild);
                        $('<a/>').attr({ id: itemData.DoorName, onclick: "fnShowMomentaryUnlock(this);" }).text(itemData.MomentaryUnlock).appendTo(pBtntag);

                        $('<div/>').addClass('clear').appendTo(dvBtnParentDiv);
                        $('<div/>').addClass('clear').appendTo(dvParent);

                    });
                    $(cList).css({ "display": "block" });
                }
            }          
                UnBlockElement("dvAccessPortlet");            
        }


        function MM_swapImgRestore() { //v3.0
            var i, x, a = document.MM_sr; for (i = 0; a && i < a.length && (x = a[i]) && x.oSrc; i++) x.src = x.oSrc;
        }
        function MM_preloadImages() { //v3.0
            var d = document; if (d.images) {
                if (!d.MM_p) d.MM_p = new Array();
                var i, j = d.MM_p.length, a = MM_preloadImages.arguments; for (i = 0; i < a.length; i++)
                    if (a[i].indexOf("#") != 0) { d.MM_p[j] = new Image; d.MM_p[j++].src = a[i]; }
            }
        }

        function MM_findObj(n, d) { //v4.01
            var p, i, x; if (!d) d = document; if ((p = n.indexOf("?")) > 0 && parent.frames.length) {
                d = parent.frames[n.substring(p + 1)].document; n = n.substring(0, p);
            }
            if (!(x = d[n]) && d.all) x = d.all[n]; for (i = 0; !x && i < d.forms.length; i++) x = d.forms[i][n];
            for (i = 0; !x && d.layers && i < d.layers.length; i++) x = MM_findObj(n, d.layers[i].document);
            if (!x && d.getElementById) x = d.getElementById(n); return x;
        }

        function MM_swapImage() { //v3.0
            var i, j = 0, x, a = MM_swapImage.arguments; document.MM_sr = new Array; for (i = 0; i < (a.length - 2); i += 3)
                if ((x = MM_findObj(a[i])) != null) { document.MM_sr[j++] = x; if (!x.oSrc) x.oSrc = x.src; x.src = a[i + 2]; }
        }
     
        function fnShowMomentaryUnlock(doorObject) {        
            fnMomentaryUnlock();
            $("#hdnDoorName").val(doorObject.id);
            
        }

        function GetReadersListCallback_Momentary(ResultSet) {
            var readersID;
            if (ResultSet != null && ResultSet != undefined) {
                if (ResultSet.Message != null && ResultSet.Message != undefined && ResultSet.Message != "") {
                    fnAccessMsgInfo(ResultSet.Message);
                }
                else {                  
                   
                    if (ResultSet != undefined && ResultSet != null) {                      
                        for (i = 0; i < ResultSet.length; i++) {
                            if (ResultSet[i].Name == $("#hdnDoorName").val()) {
                                readersID = ResultSet[i].Id;
                            }
                        }
                    }
                }
            }
            UnBlockElement("dvAccessPortlet");
            var dataItem = { "readerId": readersID, "deviceId": $("#AccessViewDeviceList").val() };
            var url = '@Url.Action("AccessMomentaryOpenDoor", "Access")';
            BlockElement("dvAccessPortlet", 'Connecting...');
            $.post(url, dataItem, GetMomentaryUnlockCallback, "json");
        }

        function CloseMomentaryOpenDoor() {
            document.getElementById('dvmomentaryUnlock').style.visibility = 'hidden';
            $("#MomentaryPopup").data("kendoWindow").close();
        }
        function fnMomentaryOpenDoorConfirm() {
            $("#dvErrMomentaryOpenDoor ul").empty();
            var deviceID = $("#AccessViewDeviceList").val();
            var cboMomentaryReaderId = $("#cboMonumentaryOpenDoor").val();

            if (cboMomentaryReaderId == '' || cboMomentaryReaderId == '-- Select --') {
                $('#dvErrMomentaryOpenDoor ul').append('<li class="validation-summary-accesspopup">Door is Required</li>');
            }
            else {
                var dataItem = { "readerId": cboMomentaryReaderId, "deviceId": deviceID };
                var url = '@Url.Action("AccessMomentaryOpenDoor", "Access")';
                BlockElement("dvAccessPortlet", 'Connecting...');
                $.post(url, dataItem, GetMomentaryUnlockCallback, "json");
            }
        }
        function GetMomentaryUnlockCallback(ResultSet) {
            if (ResultSet != null && ResultSet != undefined) {
                if (ResultSet.Message != null && ResultSet.Message != undefined && ResultSet.Message != "") {
                    fnAccessMsgInfo(ResultSet.Message);
                }
                else {
                    if (ResultSet == "OK") {
                        fnAccessMsgInfo('Door unlocked successfully.');
                       // $("#MomentaryPopup").data("kendoWindow").close();
                        var deviceId = $("#AccessViewDeviceList").val();
                        if (deviceId != null && deviceId != undefined && deviceId != '' && deviceId != 'Select Device') {
                            fnGetAccessInformation(deviceId);
                        }
                    }
                }
            }
            UnBlockElement("dvAccessPortlet");
        }

        function onAceesUserPinClose(e) {
            //UnBlockElement("dvAccessViewPortlet");
        }

        function fnMomentaryUnlock() {
            $("#hdnsubmitClick").val('');
            $("#txtUserpin").val('');
            $("#UserPinWindow").data("kendoWindow").center().open();
        }


        function fnUserpinValidation() {
            if ($('#txtUserpin').val() == '') {
                $("#txtUserpin").val('');
                alert('User Pin is mandatory.');
                return false;
            }
            else if ($('#txtUserpin').val().length < 4 || $('#txtUserpin').val().length > 6) {
                $("#txtUserpin").val('');
                alert("Please enter a valid user pin which accepts 4 to 6 digits");
                return false;
            }
            else {                
                var existingValue = $("#hdnsubmitClick").val();

                if (existingValue == '') {
                    existingValue = 1;
                }
                else {
                    existingValue = Number(existingValue) + 1;
                }
                $("#hdnsubmitClick").val(existingValue);

                var submitClick = $("#hdnsubmitClick").val();
            }
            BlockElement("dvAccessPortlet", 'Connecting...');
            var dataItem = { "UserPin": document.getElementById('hdnMaskedPin').value, "submitVal": submitClick };
            var url = '@Url.Action("ValidateUserPin", "Access")';
            $.post(url, dataItem, GetUserpinCallback, "json");

            AccessOriginalValue = "";
            document.getElementById('txtUserpin').value = '';
            document.getElementById('hdnMaskedPin').value = '';
        }

        function GetUserpinCallback(ResultSet) {
            document.getElementById('txtUserpin').value = "";
            AccessOriginalValue = "";
            document.getElementById('hdnMaskedPin').value = "";
            if (ResultSet != null && ResultSet != undefined) {
                if (ResultSet.Message != null && ResultSet.Message != undefined && ResultSet.Message != "") {
                    fnAccessMsgInfo(ResultSet.Message);
                }
                else {
                    if (ResultSet == "logoff") {
                        $("#UserPinWindow").data("kendoWindow").close();
                        var editUri = '@Url.Content("~/Account/LogOff")';
                        location.href = editUri;
                        UnBlockElement("dvAccessPortlet");
                    }
                    else if (ResultSet == "false") {
                        fnAccessMsgInfo('Invalid User Pin');
                        UnBlockElement("dvAccessPortlet");
                    }
                    else if (ResultSet == "true") {
                        $("#UserPinWindow").data("kendoWindow").close();
                        //BlockElement("dvAccessViewPortlet", 'Connecting...');
                        var parameters = { "deviceId": $("#AccessViewDeviceList").val() };
                        var url = '@Url.Action("GetReadersList", "Access")';
                        $.post(url, parameters, GetReadersListCallback_Momentary, "json");
                    } else {
                        UnBlockElement("dvAccessPortlet");
                    }
                }
            } else {
                UnBlockElement("dvAccessPortlet");
            }
        }

        function fnAccessMsgInfo(message) {
            $("#lblDieboldAlert").text(message);
            $("#DieboldAlertWindow").data("kendoWindow").center().open();
        }

        var AccessOriginalValue = "";
        function fnAccessmaskpinEntry(elem) {
            if (elem.value.length < 4) {
                if (elem.value == "") {
                    AccessOriginalValue = "";
                    //  alert("If null\nAccessOriginalValue:"+ AccessOriginalValue);                    
                }
                else if (elem.value.length < AccessOriginalValue.length) {
                    AccessOriginalValue = AccessOriginalValue.substr(0, AccessOriginalValue.length - 1);
                    // alert("If elem.value.length < AccessOriginalValue.length\nAccessOriginalValue:"+ AccessOriginalValue);
                }
                else {
                    AccessOriginalValue = AccessOriginalValue + elem.value.substr(elem.value.length - 1, 1);
                    document.getElementById('txtUserpin').value = '';
                    for (var i = 0; i < AccessOriginalValue.length; i++) {
                        document.getElementById('txtUserpin').value = document.getElementById('txtUserpin').value + "*";
                    }
                }

                document.getElementById('hdnMaskedPin').value = AccessOriginalValue;
            } else {

                AccessOriginalValue = AccessOriginalValue + elem.value.substr(elem.value.length - 1, 1);
                document.getElementById('hdnMaskedPin').value = AccessOriginalValue;
                document.getElementById('txtUserpin').value = document.getElementById('txtUserpin').value.substring(0, document.getElementById('txtUserpin').value.length - 1) + "*";
                return false;
            }
        }

    </script>
    <style type="text/css">
         #MomentaryPopup .k-block > .k-header, .k-window-titlebar
        {
            height: 1.8em;
        }
         #UserPinWindow .k-block > .k-header, .k-window-titlebar
        {
            height: 1.8em;
        }
        .usertxtboxEditIntrusion
        {
            border: 1px solid;
            border-color: #C5C5C5;
        }
    </style>
</head>
<body onload="MM_preloadImages('../../Content/images/back-btn-hovr.png')">
    <!-- Main Row Starts here -->
    <div class="row">
        <div class="sixteen columns">
            <header>
                    <div class="sixteen columns logo-small" align="center">
                    
                    	<div class="back">
                       	  <a href="../Dashboard/Home" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('back btn','','../../Content/images/back-btn-hovr.png',1)"><img src="../../Content/images/back-btn.png" name="back btn" border="0"></a>
                      </div>
                        <a href="http://www.diebold.com/dnpssec/default.htm" target="_blank"><img src="../../Content/images/logo-small.png" alt="" /></a>
                        <div class="log-out">
                        	<a href="@Url.Content("~/Account/LogOff")"><img src="../../Content/images/logout-icon.png" alt="" /></a>
                        </div>
                    </div>
				</header>
            <div class="clear">
            </div>
            <!-- MAIN CONTAINER STARTS HERE -->
            <section>
                	<article>

                        <div class="body-bg">
                            <div class="inner-cont">
                                <!-- Access Page Starts Here -->
                                <div  id="dvAccessPortlet">
                                <div class="access">
                                    <div class="main-hdr" align="center">
                                        <h1>Access</h1>
                                    </div>
                                    
                                    <div class="drop-down-sel" align="center">
                                        <select id="AccessViewDeviceList" name="AccessViewDeviceList">
                                            <option>Select Device</option>
                                        </select>
                                    </div>

                                    <div id="dvAccessInfo">
                                    </div> 
                                </div>
                                <input type="hidden" id="hdnDoorName" />
                                <!-- Access Page Ends Here -->
                                <div class="overlay_msg" id="dvmomentaryUnlock" style="left: 25%; padding: 15px; display:none;">
                                <!--Kendo window to validate user pin-->
                                    @(Html.Kendo().Window()
                                    .Name("MomentaryPopup")
                                    .Title("Momentary Unlock")
                                    .Visible(false)
                                    .Modal(true)
                                    .Content(@<text>
                                    <br />
                                    <div>
                                        <div>
                                        <label style="margin-right:1px;"><strong>Door:</strong></label>
                                        @(Html.Kendo().ComboBox()
                                        .Name("cboMonumentaryOpenDoor")
                                        .Placeholder("-- Select --")
                                        .HtmlAttributes(new { style = "width:70%" })
                                        .DataTextField("Name")
                                        .DataValueField("Id")
                                        .Suggest(true)
                                        )
                                        <div>
                                    </div>
                                    <br />
                                    <div>
                                        <div class="add-link" align="center" style="float:left; width:33%; margin-right:2%; margin-left:14%;">
                                            <input type="button" value="Confirm" onclick="fnMomentaryOpenDoorConfirm();" />
                                        </div>&nbsp;&nbsp;&nbsp;
                                        <div class="add-link" style="float:left; width:33%;">
                                            <input type="button" value="Cancel" onclick="CloseMomentaryOpenDoor();"/>
                                        </div>
                                    </div>
                                    </text>)
                                        .Draggable(false)
                                        .Width(200)
                                        .Height(200)
                                     )
                                    <div class="clear">
                                    </div>
                        </div>
                                </div>
                            </div>
                            <div>
                                <!--Kendo window to validate user pin-->
                                @(Html.Kendo().Window()
                                .Name("UserPinWindow")
                                .Title("UserPin Validation")
                                .Visible(false)
                                .Modal(true)
                                .Content(@<text>
                                <br />
                                <div id="userpinpopup">
                                    <div>
                                        <label for="UserPin" style="margin-right:2px;">User Pin:</label>
                                        @*@Html.TextBox("txtUserpin", null, new { @class = "usertxtboxEditIntrusion", maxlength = 4 })*@
                                        <input type="tel" id="txtUserpin" class="usertxtboxEditIntrusion" maxlength="6" onkeyup="fnAccessmaskpinEntry(this);"/>
                                        <input id="hdnsubmitClick" type="hidden" />
                                    </div>
                                    <div class="clear">
                                    </div>
                                    <label for="UserPin" id="lblupinstatus">
                                    </label>
                                    <div style="margin: 4% 0 0 0;">
                                        <div class="add-link" align="center">
                                            <input type="button" value="Submit" id="btnSubmit" onclick="javascript:fnUserpinValidation();" style="width:35%;" />
                                        </div>
                                    </div>
                                </div>
                                </text>)
                                    .Draggable(false)
                                    .Width(275)
                                    .Height(200)
                                    .Events(events => events.Close("onAceesUserPinClose"))
                                 )
                                </div>
                                <div>
                                    @(Html.Kendo().Window()
                                            .Name("DieboldAlertWindow")
                                            .Title("Information")
                                            .Visible(false)
                                            .Modal(true)
                                            .Content(@<text>
                                        <div style="padding: 5px">
                                            <label id="lblDieboldAlert"></label>
                                        </div>
                                        </text>)
                                            .Draggable(false)
                                            .Width(275)
                                            .Height(170)
                                        )
                                </div>
                        </div>
                         <input type="hidden" id="hdnMaskedPin" />
        </div>
        </article> </section>
    </div>
    </div>
    <!-- Main Row Ends here -->
</body>

</html>
