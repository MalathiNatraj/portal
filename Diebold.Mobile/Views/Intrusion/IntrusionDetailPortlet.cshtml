@{
    ViewBag.Title = "IntrusionDetailPortlet";
}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
	<!-- Set the viewport width to device width for mobile -->
	<meta name="viewport" content="width=320,user-scalable=false" />
	<link rel="stylesheet" type="text/css" href="../../Content/style.css">
    <!--[if gte IE 9]>
        <link rel="stylesheet" type="text/css" href="css/gradient-ie6-and-up.css" />
	<![endif]-->
	<title>Diebold</title>
    
    <script src="@Url.Content("~/Scripts/jquery.blockUI.js")" type="text/javascript"></script>
    <link href="@Url.Content("~/Content/kendo.dataviz.min.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Scripts/jquery.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.dataviz.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.aspnetmvc.min.js")" type="text/javascript"></script>
    <link rel="stylesheet" href="@Url.Content("~/Content/kendo.common.min.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Content/kendo.default.min.css")" />
    <script src="@Url.Content("~/Scripts/jquery.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/kendo.web.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery-1.9.1.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/nav/multilevel.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/nav/responder.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/nav/slider.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/app/Common.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.blockUI.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/app/BlockUIForms.js")" type="text/javascript"></script>
    <link href="@Url.Content("~/Content/BlockUIForms.css")" rel="stylesheet" type="text/css" />
	<script type="text/javascript">
	    $(document).ready(function () {
	        $('#IntrusionCategories').empty();
	        $.ajax({
	            url: '@Url.Action("GetDeviceListforIntrusion", "Intrusion")',
	            type: 'POST',
	            data: { parentType: 'DVR' },
	            success: function (data) {
	                $('#IntrusionCategories').append($('<option/>', {
	                    value: "Select Device",
	                    text: "Select Device"
	                }));
	                $.each(data, function (index, itemData) {
	                    $('#IntrusionCategories').append($('<option/>', {
	                        value: itemData.Id,
	                        text: itemData.SiteName + ' : '+ itemData.Name
	                    }));
	                });
	                
	            },
	            error: function (errordata) {
	                alert('Failure')
	            }
	        });

	        $('#IntrusionCategories').change(function () {
	            BlockElement("dvIntrusionPortlet", 'Connecting...');
	            var deviceId = $("#IntrusionCategories").val();
	            if (deviceId != null && deviceId != undefined && deviceId != '' && deviceId != 'Select Device') {
	                selectIntrusionDevice(deviceId);
	            }
	            else
	                UnBlockElement("dvIntrusionPortlet");
	        });

	        $('#ddlIntrusionArea').change(function () {
	            var areaValue = $("#ddlIntrusionArea").val();
	            fnGetZones(areaValue);
	        });
	    });


        var intrusionDataItem;
        function selectIntrusionDevice(vals) {
            $.ajax({
                url: '@Url.Action("GetIntrusionDetails", "Intrusion")',
                type: 'POST',
                data: { deviceId: vals },
                success: function (data) {
                    fnLoadAreaDropdown(data)
                },
                error: function (errordata) {
                    alert('Failure')
                }
            });

            $.ajax({
                url: '@Url.Action("GetIntrusionReport", "Intrusion")',
                type: 'POST',
                data: { deviceId: vals },
                success: function (data) {
                    fnUpdateReportData(data)
                },
                error: function (errordata) {
                    alert('Failure')
                }
            });
        }

        function fnUpdateReportData(Result) {
            if (Result != null && Result != undefined) {
                if (Result.Message != null && Result.Message != undefined && Result.Message != "") {
                    fnIntrusionMsgInfo(Result.Message);
                }
                else {
                    var cList = $('#dvReportMessage');
                    $("#dvReportMessage").empty();
                    var messages = Result.split('|');
                    $.each(messages, function (index, itemData) {
                        var anchor = $('<a/>').text(itemData).appendTo(cList);
                        var dvClear = $('<div/>').addClass('clear').appendTo(cList);
                    });
                    $("#dvReportDetails").css({ "display": "block" });
                }
            }
        }

        function fnLoadAreaDropdown(ResultSet) {
            if (ResultSet != null && ResultSet != undefined) {
                if (ResultSet.Message != null && ResultSet.Message != undefined && ResultSet.Message != "") {
                    fnIntrusionMsgInfo(ResultSet.Message);
                }
                else {
                    fnSetStatusValues();
                    $.each(ResultSet, function (index, itemData) {
                        $('#ddlIntrusionArea').val('Select Area');
                        $('#ddlIntrusionArea').append($('<option/>', {
                            value: itemData.AreaNumber,
                            text: itemData.AreaName
                        }));
                    });
                }
            }
            UnBlockElement("dvIntrusionPortlet");
        }

        function fnSetStatusValues() {
            var pollingUrl = '@Url.Action("GetPollingStatus", "Intrusion")';
            $.post(pollingUrl, fnStatusCallback, "json")
        }

        function fnStatusCallback(Result) {
            if (Result != null && Result != undefined) {
                if (Result.Message != null && Result.Message != undefined && Result.Message != "") {
                    fnIntrusionMsgInfo(Result.Message);
                }
                else {
                    $("#lblIntruPollingStatus").text(Result.PollingStatus);
                    $("#lblIntruStatus").text(Result.Status);
                }
            }
        }

        function fnGetZones(value) {
            var url = '@Url.Action("GetZonesByArea", "Intrusion")';
            var dataItem = { "areNumber": value };
            $.post(url, dataItem, fnPopulateZoneInfomation, "json");

            var url = '@Url.Action("GetAreaArmedStatus", "Intrusion")';
            var dataItem = { "areNumber": value };
            $.post(url, dataItem, fnAreaArmedStatus, "json");
           
        }

        function fnAreaArmedStatus(Result) {
            $("#lblIntrusionAreArm").text(Result);
        }


        function fnPopulateZoneInfomation(Result) {
            if (Result != null && Result != undefined) {
                if (Result.Message != null && Result.Message != undefined && Result.Message != "") {
                    fnIntrusionMsgInfo(Result.Message);
                }
                else {
                    var cList = $('#dvAreaZoneList');
                    $("#dvAreaZoneList").empty();

                    $.each(Result, function (index, itemData) {
                        var dvTtleparent = $('<div/>').addClass('lft-cont').appendTo(cList);
                        var ul = $('<ul/>').appendTo(dvTtleparent);
                        var li = $('<li/>').addClass('li-menu-item').appendTo(ul);
                        var anchor = $('<a/>').text(itemData.Name).appendTo(li);

                        var dvBtnParent = $('<div/>').addClass('right-cont').appendTo(cList);
                        if (itemData.Status == "Normal") {
                            var dvChild = $('<div/>').addClass('big-active-btn').appendTo(dvBtnParent);
                            var ptag = $('<p/>').appendTo(dvChild);
                            var link = $('<a/>').attr({ id: itemData.ZoneNumber, onclick: "fnZoneByPass(this);" }).text('Active').appendTo(ptag);
                        }
                        else {
                            var dvChild = $('<div/>').addClass('inact-btn').appendTo(dvBtnParent);
                            var ptag = $('<p/>').appendTo(dvChild);
                            var link = $('<a/>').attr({ id: itemData.ZoneNumber, onclick: "fnZoneByPass(this);" }).text('Bypass').appendTo(ptag);
                        }
                        var dvClear = $('<div/>').addClass('clear').appendTo(cList);
                    });

                    $(cList).css({ "display": "block" });

                    $("#dvArm").css({ "display": "block" });
                }
            }
        }


	    function MM_swapImgRestore() { //v3.0
	        var i, x, a = document.MM_sr; for (i = 0; a && i < a.length && (x = a[i]) && x.oSrc; i++) x.src = x.oSrc;
	    }
	    function MM_preloadImages() { //v3.0
	        var d = document; if (d.images) {
	            if (!d.MM_p) d.MM_p = new Array();
	            var i, j = d.MM_p.length, a = MM_preloadImages.arguments; for (i = 0; i < a.length; i++)
	                if (a[i].indexOf("#") != 0) { d.MM_p[j] = new Image; d.MM_p[j++].src = a[i]; }
	        }
	    }

	    function MM_findObj(n, d) { //v4.01
	        var p, i, x; if (!d) d = document; if ((p = n.indexOf("?")) > 0 && parent.frames.length) {
	            d = parent.frames[n.substring(p + 1)].document; n = n.substring(0, p);
	        }
	        if (!(x = d[n]) && d.all) x = d.all[n]; for (i = 0; !x && i < d.forms.length; i++) x = d.forms[i][n];
	        for (i = 0; !x && d.layers && i < d.layers.length; i++) x = MM_findObj(n, d.layers[i].document);
	        if (!x && d.getElementById) x = d.getElementById(n); return x;
	    }

	    function MM_swapImage() { //v3.0
	        var i, j = 0, x, a = MM_swapImage.arguments; document.MM_sr = new Array; for (i = 0; i < (a.length - 2); i += 3)
	            if ((x = MM_findObj(a[i])) != null) { document.MM_sr[j++] = x; if (!x.oSrc) x.oSrc = x.src; x.src = a[i + 2]; }
	    }



	    function fnArmDisarm() {
	        BlockElement("dvIntrusionPortlet", 'Connecting...');
	        $("#hdnsubmitClick").val('');
	        $("#txtUserpin").val('');
	        $("#UserPinWindow").data("kendoWindow").center().open();
	    }

	    function fnUserpinValidation() {
	        if ($('#txtUserpin').val() == '') {
	            $("#txtUserpin").val('');
	            alert('User Pin is mandatory.');
	            return false;
	        }
	        else if ($('#txtUserpin').val().length < 4 || $('#txtUserpin').val().length > 6) {
	            $("#txtUserpin").val('');
	            alert("Please enter a valid user pin which accepts 4 to 6 digits");
	            return false;
	        }
	        else {
	            var existingValue = $("#hdnsubmitClick").val();

	            if (existingValue == '') {
	                existingValue = 1;
	            }
	            else {
	                existingValue = Number(existingValue) + 1;
	            }
	            $("#hdnsubmitClick").val(existingValue);

	            var submitClick = $("#hdnsubmitClick").val();
	        }
	        var areanum = $("#ddlIntrusionArea").val();
	        var areaArm = $("#lblIntrusionAreArm").text();
	        var deviceId = $("#IntrusionCategories").val();

	        if (areaArm == "Arm") {
	            areaArm = "true";
	        }
	        else {
	            areaArm = "false";
	        }

	        var dataItem = { "UserPin": document.getElementById('hdnMaskedPin').value, "submitVal": submitClick, "areaNumber": areanum, "arm": areaArm, "deviceId": deviceId };
	        var url = '@Url.Action("ValidateUserPin", "Intrusion")';
	        $.post(url, dataItem, GetUserpinCallback, "json");
	        intrusionOriginalValue = "";
	        document.getElementById('txtUserpin').value = '';
	        document.getElementById('hdnMaskedPin').value = '';
	    }

	    function GetUserpinCallback(ResultSet) {
	        document.getElementById('txtUserpin').value = '';
	        intrusionOriginalValue = "";
	        document.getElementById('hdnMaskedPin').value = "";
	        if (ResultSet != null && ResultSet != undefined) {
	            if (ResultSet.Message != null && ResultSet.Message != undefined && ResultSet.Message != "") {
	                fnIntrusionMsgInfo(ResultSet.Message);
	            }
	            else {
	                if (ResultSet == "logoff") {
	                    $("#UserPinWindow").data("kendoWindow").close();
	                    var editUri = '@Url.Content("~/Account/LogOff")';
	                    location.href = editUri;
	                }
	                else if (ResultSet == "false") {
	                    alert('Invalid User Pin');
	                }
	                else if (ResultSet == "OK") {
	                    $("#UserPinWindow").data("kendoWindow").close();

	                    var areaArm = $("#lblIntrusionAreArm").text();
	                    if (areaArm == "Arm") {
	                        $("#lblIntrusionAreArm").text("Disarm");
	                    }
	                    else {
	                        $("#lblIntrusionAreArm").text("Arm");
	                    }
	                }
	            }
	        }
            UnBlockElement("dvIntrusionPortlet");
        }

        function fnZoneByPass(button) {
            BlockElement("dvIntrusionPortlet", 'Connecting...');
            var deviceId = $("#IntrusionCategories").val();
            var zoneNum = button.id;
            var byPass = button.text;
            
            if (byPass == "Active") {
                byPass = "true";
            }
            else {
                byPass = "false";
            }

            var dataItem = { "zoneNumber": zoneNum, "deviceId": deviceId, "byPass": byPass };
            var url = '@Url.Action("ZoneByPass", "Intrusion")';
            $.post(url, dataItem, GetzoneByPassCallback, "json");
        }


        function GetzoneByPassCallback(ResultSet) {
            if (ResultSet != null && ResultSet != undefined) {
                if (ResultSet.Message != null && ResultSet.Message != undefined && ResultSet.Message != "") {
                    fnIntrusionMsgInfo(ResultSet.Message);
                }
                else {
                    if (ResultSet == "OK") {
                        var areaValue = $("#ddlIntrusionArea").val();
                        var deviceId = $("#IntrusionCategories").val();
                        selectIntrusionDevice(deviceId);
                        $("#ddlIntrusionArea").val(areaValue)
                        fnGetZones(areaValue);
                    }
                }
            }
            UnBlockElement("dvIntrusionPortlet");
        }

        function onUserPinClose(e) {
            UnBlockElement("dvIntrusionPortlet");
        }

        function fnIntrusionMsgInfo(message) {
            $("#lblDieboldAlert").text(message);
            $("#DieboldAlertWindow").data("kendoWindow").center().open();
        }

        var intrusionOriginalValue = "";
        function fnIntrmaskpinEntry(elem) {
            if (elem.value.length < 4) {
                if (elem.value == "") {
                    intrusionOriginalValue = "";
                    //  alert("If null\nintrusionOriginalValue:"+ intrusionOriginalValue);                    
                }
                else if (elem.value.length < intrusionOriginalValue.length) {
                    intrusionOriginalValue = intrusionOriginalValue.substr(0, intrusionOriginalValue.length - 1);
                    // alert("If elem.value.length < intrusionOriginalValue.length\nintrusionOriginalValue:"+ intrusionOriginalValue);
                }
                else {
                    intrusionOriginalValue = intrusionOriginalValue + elem.value.substr(elem.value.length - 1, 1);
                    document.getElementById('txtUserpin').value = '';
                    for (var i = 0; i < intrusionOriginalValue.length; i++) {
                        document.getElementById('txtUserpin').value = document.getElementById('txtUserpin').value + "*";
                    }
                }

                document.getElementById('hdnMaskedPin').value = intrusionOriginalValue;
            } else {

                intrusionOriginalValue = intrusionOriginalValue + elem.value.substr(elem.value.length - 1, 1);
                document.getElementById('hdnMaskedPin').value = intrusionOriginalValue;
                document.getElementById('txtUserpin').value = document.getElementById('txtUserpin').value.substring(0, document.getElementById('txtUserpin').value.length - 1) + "*";
                return false;
            }
        }

    </script>
    <style type="text/css">
        .li-menu-item{font-size:large;}
        .usertxtboxEditIntrusion
        {
            border: 1px solid;
            border-color: #C5C5C5;
        }
         #UserPinWindow .k-block > .k-header, .k-window-titlebar
        {
            height: 1.8em;
        }
    </style>
</head>

<body onLoad="MM_preloadImages('../../Content/images/back-btn-hovr.png')">
        <!-- Main Row Starts here -->
      <div class="row">
        	<div class="sixteen columns">
            	<header>
                    <div class="sixteen columns logo-small" align="center">
                    
                    	<div class="back">
                       	  <a href="../Dashboard/Home" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('back btn','','../../Content/images/back-btn-hovr.png',1)"><img src="../../Content/images/back-btn.png" name="back btn" border="0"></a>
                      </div>
                    	<a href="http://www.diebold.com/dnpssec/default.htm" target="_blank"><img src="../../Content/images/logo-small.png" alt="" /></a>
                        <div class="log-out">
                        	<a href="@Url.Content("~/Account/LogOff")"><img src="../../Content/images/logout-icon.png" alt="" /></a>
                        </div>
                    </div>
				</header>
                <div class="clear"></div>	
                
                <!-- MAIN CONTAINER STARTS HERE -->
                <section>
                	<article>
                        <div id="dvIntrusionPortlet">
                        <div class="drop-down-sel" align="center" style="margin:2% 0;">
                            <select id="IntrusionCategories" name="IntrusionCategories">
                                <option>Select Device</option>
                            </select>
                        </div>

                        <div class="body-bg">
                            <div class="inner-cont">
                                
                                <!-- INTRUSION PAGE STARTS HERE -->
                                <div class="intru">
                                    
                                    <div class="box-cont-bg">
                                        <div class="intru-poll-cont">
                                        	<p>Polling Status: 
                                                <strong>
                                                    <label id="lblIntruPollingStatus">
                                                    </label>
                                                </strong>
                                            </p>
                                        	<p>Timezone: <strong>EST</strong></p>
                                        	<p>Status: 
                                                 <strong>
                                                    <label id="lblIntruStatus">
                                                    </label>
                                                 </strong>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="drop-down-sel" align="center" style="margin:2% 0;">
                                        <select id="ddlIntrusionArea" name="ddlIntrusionArea">
                                            <option>Select Area</option>
                                        </select>
                                    </div>
                                    <div id="dvAreaZoneList">
                                    </div>
                                    <div id="dvArm" class="place-on-test" align="center" style="display:none;">
                                        <p><a href="#" onclick="fnArmDisarm();"><strong><label id="lblIntrusionAreArm">Disarm</label></strong></a></p>
                                    </div>
                                    <div id="dvReportDetails" class="box-cont-bg" style="display:none;">
                                        <div class="intru-poll-cont">
                                            <p><strong>Details:</strong></p>
                                            <p><div id="dvReportMessage"></div></p>
                                        </div>
                                    </div>
                                </div>
                                <!-- INTRUSION PAGE ENDS HERE -->
                                <input type="hidden" id="hdnMaskedPin" />
                            </div>
                        </div>
                        </div>
                        <div>
                        <!--Kendo window to validate user pin-->
                        @(Html.Kendo().Window()
                        .Name("UserPinWindow")
                        .Title("UserPin Validation")
                        .Visible(false)
                        .Modal(true)
                        .Content(@<text>
                        <br />
                        <div id="userpinpopup">
                            <div>
                                <label for="UserPin" style="margin-right:2px;">User Pin:</label>
                                @*@Html.TextBox("txtUserpin", null, new { @class = "usertxtboxEditIntrusion", maxlength = 4 })*@
                                <input type="tel" id="txtUserpin" class="usertxtboxEditIntrusion" maxlength="6" onkeyup="fnIntrmaskpinEntry(this);"/>
                                <input id="hdnsubmitClick" type="hidden" />
                            </div>
                            <div class="clear">
                            </div>
                            <label for="UserPin" id="lblupinstatus">
                            </label>
                            <div style="margin: 4% 0 0 0;">
                                <div class="add-link" align="center">
                                    <input type="button" value="Submit" id="btnSubmit" onclick="javascript:fnUserpinValidation();" style="width:35%;" />
                                </div>
                            </div>
                        </div>
                        </text>)
                            .Draggable(false)
                            .Width(275)
                            .Height(200)
                            .Events(events => events.Close("onUserPinClose"))
                         )
                        </div>
                        <div>
                        @(Html.Kendo().Window()
                                .Name("DieboldAlertWindow")
                                .Title("Information")
                                .Visible(false)
                                .Modal(true)
                                .Content(@<text>
                            <div style="padding: 5px">
                                <label id="lblDieboldAlert"></label>
                            </div>
                            </text>)
                                .Draggable(false)
                                .Width(275)
                                .Height(170)
                            )
                        </div>
                    </article>
                </section>
            </div>
        </div>
        <!-- Main Row Ends here -->
	
</body>
</html>

